import{i as x,_ as G,A as p,B as J,C as Q,G as X,H as Z,r as k,W as ee,o as se,a as E,m as M,b as v,d as f,e as t,F as D,k as P,t as C,q as y,s as K,R as ae,S as te,E as S,n as I,h as U,J as N,K as ne,f as oe,O as re}from"./index-eda97db9.js";const ie=u=>x.get("/user/chat?username="+u),le=(u,w)=>x.get(`/user/history?user1=${u}&user2=${w}`),ce=u=>x.get(`/user/unread?username=${u}`),Y=(u,w)=>x.post(`/user/mark-read?fromUser=${u}&toUser=${w}`),ue=u=>x.get("/user/online-status",{params:{usernames:u.join(",")}});const de={class:"chat-page"},me={class:"chat-list"},ve={class:"chat-items"},fe=["onClick"],_e={class:"avatar-wrapper"},he={class:"avatar-container"},pe={class:"chat-info"},ye={class:"chat-header"},Ce={class:"nickname"},we={class:"last-message"},ge={key:0,class:"unread-count"},ke={class:"chat-area"},Me={class:"chat-header"},Se={class:"user-info"},xe={class:"nickname"},He={class:"message-wrapper"},De={class:"message-content"},Ie={class:"message-time"},Ue={class:"chat-input"},Ye={class:"input-tools"},be={class:"input-area"},Te={class:"send-btn"},Oe={key:1,class:"empty-chat"},Ve={__name:"UserChat",setup(u){p.extend(J),p.locale("zh-cn");const w=Q(),R=X(),c=Z(()=>R.info),o=k([]),n=k(null),g=k([]),m=k(""),b=k(null),_=new ee("ws://127.0.0.1:8080/ws/chat",c.value.username),T=async e=>{try{const s=await ie(e);if(console.log("Chat user response:",s),s.data&&s.data[0]){const a=s.data[0],i={id:Date.now(),username:a.username||e,nickname:a.nickname||e,userPic:a.userPic||"default-avatar.jpg",lastMessage:a.message||"",lastTime:p().format("YYYY-MM-DD HH:mm:ss")};console.log("Created new chat:",i);const d=o.value.find(h=>h.username===e);d?n.value=d:(o.value.unshift(i),n.value=i),O(n.value)}else S.warning("未找到用户信息")}catch(s){console.error("获取聊天对象信息失败:",s),S.error("获取聊天对象信息失败")}},L=async()=>{try{if(!c.value)return;const e=await ce(c.value.username);e.code===0&&e.data&&o.value.forEach(s=>{e.data[s.username]&&(s.unreadCount=e.data[s.username])})}catch(e){console.error("获取未读消息数量失败:",e)}},O=async e=>{n.value=e,e.unreadCount=0,await q(e.id),c.value&&await Y(e.username,c.value.username)},q=async e=>{try{if(!n.value||!c.value)return;const s=await le(c.value.username,n.value.username);s.data&&(g.value=s.data.map(a=>({id:a.id,content:a.content,isSelf:a.fromUser===c.value.username,time:p(a.createTime).format("HH:mm")})),await Y(n.value.username,c.value.username)),await I(),H()}catch(s){console.error("获取聊天记录失败:",s),S.error("获取聊天记录失败")}},V=async()=>{if(!m.value.trim()){S.warning("消息不能为空");return}if(!n.value||!n.value.username){S.warning("请选择聊天对象");return}const e={type:"chat",data:{to:n.value.username,content:m.value.trim(),time:p().format("YYYY-MM-DD HH:mm:ss")}};if(_.sendMessage(e),g.value.push({id:Date.now(),content:m.value,isSelf:!0,time:e.data.time}),n.value){n.value.lastMessage=m.value.trim(),n.value.lastTime=e.data.time;const s=o.value.findIndex(a=>a.username===n.value.username);if(s>0){const a=o.value[s];o.value.splice(s,1),o.value.unshift(a)}}m.value="",await I(),H()},$=async e=>{if(e.type==="chat"){const{from:s,content:a,time:i}=e.data;if(g.value.some(l=>l.content===a&&l.time===i&&!l.isSelf))return;if(n.value&&s===n.value.username)g.value.push({id:Date.now(),content:a,isSelf:!1,time:i}),await Y(s,c.value.username);else{const l=o.value.findIndex(r=>r.username===s);l!==-1&&(o.value[l].unreadCount=(o.value[l].unreadCount||0)+1)}const h=o.value.findIndex(l=>l.username===s);if(h!==-1){const l=o.value[h];l.lastMessage=a,l.lastTime=i,o.value.splice(h,1),o.value.unshift(l)}else await T(s);n.value&&s===n.value.username&&(await I(),H())}},H=()=>{const e=b.value;e&&(e.scrollTop=e.scrollHeight)},A=e=>{const s=p(e),a=p(),i=a.diff(s,"day"),d=a.diff(s,"year");return i<1?s.format("HH:mm"):i===1?`昨天 ${s.format("HH:mm")}`:i<7?s.format("ddd HH:mm"):d<1?s.format("MM-DD HH:mm"):s.format("YYYY-MM-DD HH:mm")},F=()=>{},W=e=>e?e>99?"99+":e:"",j=async()=>{try{const e=o.value.map(a=>a.username);if(e.length===0)return;const s=await ue(e);s.code===0&&(o.value=o.value.map(a=>({...a,isOnline:s.data[a.username]||!1})))}catch(e){console.error("获取在线状态失败:",e)}},z=e=>{if(e.type==="status"){const{username:s,online:a}=e.data,i=o.value.findIndex(d=>d.username===s);i!==-1&&(o.value[i].isOnline=a)}};return _.onMessage(e=>{e.type==="chat"?$(e):e.type==="status"&&z(e)}),se(async()=>{_.isConnected||_.connect(),_.onMessage($),_.onStatus(z);const e=w.query.username;e&&await T(e),await L(),j();const s=setInterval(j,3e4);E(()=>{clearInterval(s)})}),E(()=>{_.close()}),(e,s)=>{const a=M("el-avatar"),i=M("el-icon"),d=M("el-input"),h=M("el-button"),l=M("el-empty");return v(),f("div",de,[t("div",me,[s[1]||(s[1]=t("div",{class:"list-header"},[t("h3",null,"私信列表")],-1)),t("div",ve,[(v(!0),f(D,null,P(o.value,r=>{var B;return v(),f("div",{key:r.id,class:U(["chat-item",{active:((B=n.value)==null?void 0:B.id)===r.id}]),onClick:$e=>O(r)},[t("div",_e,[t("div",he,[y(a,{size:40,src:r.userPic},null,8,["src"]),t("div",{class:U(["online-status",{online:r.isOnline}])},null,2)])]),t("div",pe,[t("div",ye,[t("span",Ce,C(r.nickname),1)]),t("div",we,[N(C(r.lastMessage)+" ",1),r.unreadCount?(v(),f("span",ge,C(W(r.unreadCount)),1)):ne("",!0)])])],10,fe)}),128))])]),t("div",ke,[n.value?(v(),f(D,{key:0},[t("div",Me,[t("div",Se,[t("span",xe,C(n.value.nickname),1)])]),t("div",{class:"chat-messages",ref_key:"messageContainer",ref:b},[(v(!0),f(D,null,P(g.value,r=>(v(),f("div",{key:r.id,class:U(["message-bubble",{self:r.isSelf,offline:r.isOffline}])},[y(a,{size:32,src:r.isSelf?c.value.userPic:n.value.userPic},null,8,["src"]),t("div",He,[t("div",De,C(r.content),1),t("div",Ie,C(A(r.sendTime)),1)])],2))),128))],512),t("div",Ue,[t("div",Ye,[t("div",{class:"emoji-picker",onClick:F},[y(i,null,{default:K(()=>[y(oe(re))]),_:1})])]),t("div",be,[y(d,{modelValue:m.value,"onUpdate:modelValue":s[0]||(s[0]=r=>m.value=r),type:"textarea",rows:3,placeholder:"发送消息...",resize:"none",onKeyup:ae(te(V,["exact"]),["enter","native"])},null,8,["modelValue","onKeyup"])]),t("div",Te,[y(h,{type:"primary",disabled:!m.value.trim(),onClick:V},{default:K(()=>s[2]||(s[2]=[N(" 发送 ")])),_:1},8,["disabled"])])])],64)):(v(),f("div",Oe,[y(l,{description:"选择一个聊天"})]))])])}}},ze=G(Ve,[["__scopeId","data-v-68f7ebf2"]]);export{ze as default};
